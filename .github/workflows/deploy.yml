name: Deploy to alwaysdata

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ”§ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      # Root-level dependencies
      - name: â™»ï¸ Cache root node_modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-root-${{ hashFiles('package-lock.json') }}

      - name: ðŸ§¹ Install root dependencies
        run: npm ci

      # Frontend dependencies
      - name: â™»ï¸ Cache frontend node_modules
        uses: actions/cache@v3
        with:
          path: apps/web/node_modules
          key: ${{ runner.os }}-web-${{ hashFiles('apps/web/package-lock.json') }}

      - name: ðŸ§± Build Frontend (Vite)
        working-directory: apps/web
        run: |
          npm ci
          npm run build

      # Backend dependencies
      - name: â™»ï¸ Cache backend node_modules
        uses: actions/cache@v3
        with:
          path: apps/server/node_modules
          key: ${{ runner.os }}-server-${{ hashFiles('apps/server/package-lock.json') }}

      - name: Debug Secrets (temporary)
        run: |
          echo "SSH key exists: ${{ secrets.ALWAYSDATA_SSH_KEY != '' }}"
          echo "Host: ${{ secrets.AD_HOST }}"
          echo "User: ${{ secrets.AD_USER }}"

      # Check folders exist before building
      - name: ðŸ“‚ Ensure remote deploy folders exist
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.AD_HOST }}
          username: ${{ secrets.AD_USER }}
          key: ${{ secrets.ALWAYSDATA_SSH_KEY }}
          script: |
            mkdir -p ${{ secrets.AD_REMOTE_WEB_PATH }}
            mkdir -p ${{ secrets.AD_REMOTE_SERVER_PATH }}

      - name: ðŸ—ï¸ Build Backend (TypeScript)
        working-directory: apps/server
        run: |
          npm ci
          npm run build

      - name: ðŸ“¦ Upload frontend build to alwaysdata
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AD_HOST }}
          username: ${{ secrets.AD_USER }}
          key: ${{ secrets.ALWAYSDATA_SSH_KEY }}
          source: apps/web/dist/*
          target: ${{ secrets.AD_REMOTE_WEB_PATH }}

      - name: ðŸ“¦ Upload backend build to alwaysdata
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AD_HOST }}
          username: ${{ secrets.AD_USER }}
          key: ${{ secrets.ALWAYSDATA_SSH_KEY }}
          source: apps/server/dist/*
          target: ${{ secrets.AD_REMOTE_SERVER_PATH }}

      - name: ðŸš€ Start or Restart PM2 (backend)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.AD_HOST }}
          username: ${{ secrets.AD_USER }}
          key: ${{ secrets.ALWAYSDATA_SSH_KEY }}
          script: |
            cd ${{ secrets.AD_REMOTE_SERVER_PATH }}
            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi
            if pm2 list | grep -q WordleTracker; then
              pm2 reload WordleTracker
            else
              pm2 start index.js --name WordleTracker
            fi
